<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>用户发帖审核</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}" media="all"/>
    <link rel="stylesheet" th:href="@{/css/public.css}" media="all"/>
</head>
<body class="childrenBody">
<!-- 搜索条件开始 -->
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>查询条件</legend>
</fieldset>
<blockquote class="layui-elem-quote">
    <form class="layui-form" method="post" id="searchFrm">

        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">主题:</label>
                <div class="layui-input-inline">
                    <input type="text" name="title" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class='layui-form-label'>审核状态：</label>
                <div class="layui-input-block">
                    <select name="status">
                        <option value="">--请选择审核状态--</option>
                        <option value="0">未审核</option>
                        <option value="1">审核通过</option>
                        <option value="2">审核不通过</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">&nbsp;&nbsp;&nbsp;&nbsp;</label>
                <div class="layui-input-inline">
                    <button type="button" class="layui-btn layui-btn-normal  layui-icon layui-icon-search"
                            id="doSearch">查询
                    </button>
                    <button type="reset" class="layui-btn layui-btn-warm  layui-icon layui-icon-refresh">重置</button>
                </div>
            </div>
        </div>
    </form>
</blockquote>
<!-- 搜索条件结束 -->

<!-- 数据表格开始 -->
<table class="layui-hide" id="postTable" lay-filter="postTable"></table>

<script type="text/html" id="postBar" style="display: none;">
    {{# if(d.status == 0 ){ }}
    <a class="layui-btn layui-btn-agree layui-btn-xs" lay-event="agree">通过</a>
    {{# } }}
    {{# if(d.status == 0 ){ }}
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="refuse">不通过</a>
    {{# } }}
    <!--    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>-->
</script>
<!-- 数据表格结束 -->

<script th:src="@{/layui/layui.js}"></script>
<script type="text/javascript" th:inline="none">
    var tableIns;
    layui.use(['jquery', 'layer', 'form', 'table'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        //渲染数据表格
        tableIns = table.render({
            elem: '#postTable',   //渲染的目标对象
            url: 'post/selectAllPost', //数据接口
            title: '数据表',//数据导出来的标题
            toolbar: "#postToolBar",  //表格的工具条
            height: 'full-160',
            cellMinWidth: 160, //设置列的最小默认宽度
            page: 1,  //是否启用分页, limits: [10, 20, 30]
            limits: [10, 20, 30],
            limit: 10,//默认采用3
            cols: [[   //列表数据
                {field: 'id', title: '编号', align: 'center', sort: true},
                {field: 'username', title: '发布者', align: 'center'},
                {field: 'title', title: '主题', align: 'center'},
                {
                    field: 'image', title: '图片', align: 'center',
                    templet: function (d) {
                        if (d.image != '' || d.image != null)
                            return '<div><img id="photomax" style="height: 35px;width: 140px"  src="' + d.image + '"></div>'
                        else
                            return '<div>用户未上传</div>'
                    }
                },
                {field: 'content', title: '内容', align: 'center'},
                {
                    field: 'status', title: '审核状态', align: 'center', templet: function (d) {
                        switch (d.status) {
                            case 0:
                                return '<font color=blue>待审核</font>';
                                break;
                            case 1:
                                return '<font color=blue>审核通过</font>';
                                break;
                            case 2:
                                return '<font color=red>审核驳回</font>';
                                break;
                        }
                    }
                },
                {field: 'createtime', title: '发帖时间', align: 'center'},
                {fixed: 'right', title: '操作', toolbar: '#postBar', align: 'center'}
            ]]
        });
        //模糊查询
        $("#doSearch").click(function () {
            var params = $("#searchFrm").serialize();
            tableIns.reload({
                url: "post/selectAllPost?" + params
            })
        });

        //监听行工具事件
        table.on('tool(postTable)', function (obj) {
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            if (layEvent === 'agree') {
                layer.confirm('确认通过【' + data.title + '】审核吗', function (index) {
                    $.post("post/changePostStatus", {id: data.id, status: 1}, function (res) {
                        layer.msg(res);
                        //刷新数据 表格
                        tableIns.reload();
                    })
                });
            } else if (layEvent === 'refuse') {
                layer.confirm('确认驳回【' + data.title + '】审核吗', function (index) {
                    $.post("post/changePostStatus", {id: data.id, status: 2}, function (res) {
                        layer.msg(res);
                        //刷新数据 表格
                        tableIns.reload();
                    })
                });
            }
            // if (layEvent === 'del') { //删除
            //     layer.confirm('真的删除【' + data.title + '】这个帖子吗', function (index) {
            //         //向服务端发送删除指令
            //         $.post("post/deletePost", {id: data.id}, function (res) {
            //             // layer.msg(res);
            //             //刷新数据 表格
            //             layer.close(layer.index);
            //             tableIns.reload();
            //         })
            //     });
            // }
        });


        /**
         * 图片放大预览
         */
        $(document).on('click', '#photomax', function () {
            showImg($(this));
        });

        /**
         * 图片放大预览
         */
        function showImg(imgData) {
            var img = new Image();
            img.src = imgData.attr("src");
            var height = img.height; // 原图片大小
            var width = img.width; //原图片大小

            var winHeight = $(window).height() - 80;  // 浏览器可视部分高度
            var winWidth = $(window).width() - 100;  // 浏览器可视部分宽度

            // 如果图片高度或者宽度大于限定的高度或者宽度则进行等比例尺寸压缩
            if (height > winHeight || width > winWidth) {
                // 1.原图片宽高比例 大于等于 图片框宽高比例
                if (winWidth / winHeight <= width / height) {
                    width = winWidth;   //以框的宽度为标准
                    height = winWidth * (height / width);
                }

                // 2.原图片宽高比例 小于 图片框宽高比例
                if (winWidth / winHeight > width / height) {
                    width = winHeight * (width / height);
                    height = winHeight;   //以框的高度为标准
                }
            }
            var imgHtml = "<img src='" + img.src + "' width='" + width + "px' height='" + height + "px' />";
            //弹出层
            layer.open({
                type: 1,
                shade: 0.8,
                offset: 'auto',
                // area: [500 + 'px',550+'px'],
                area: [width + 'px', (height + 50) + 'px'],  //原图显示,高度+50是为了去除掉滚动条
                shadeClose: true,
                scrollbar: false,
                title: "图片预览", //不显示标题
                content: imgHtml, //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
                cancel: function () {
                    //layer.msg('捕获就是从页面已经存在的元素上，包裹layer的结构', { time: 5000, icon: 6 });
                }
            });
        }

    });
</script>
</body>
</html>